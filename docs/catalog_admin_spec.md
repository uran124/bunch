# Админка: раздел «Каталог»

## 1. Цели
- Ведение регулярных и разовых поставок (включая стендинги).
- Управление товарами, привязанными к поставкам.
- Управление акционными товарами, не связанными с поставками.
- Настройка атрибутов товара с влиянием на цену и фото.
- Поддержка мелкого опта: бронирование целых пачек из конкретной поставки.

## 2. Структура раздела «Каталог»
В меню админки появляются подпункты:
- Каталог
  - Товары
  - Акции
  - Атрибуты
  - Поставки

### 2.1. Товары
Раздел для карточек товаров, привязанных к поставкам.

#### 2.1.1. Список товаров
- Колонки: ID, наименование (клиентское), привязка к поставке («Поставка: <название> (дата)»), активность (тогглер), есть атрибуты (да/нет), базовая цена, дата создания/изменения.
- Действия: редактировать, удалить.
- Фильтры: активность, поставка, поиск по имени.

#### 2.1.2. Карточка товара
- Общие данные: привязка к поставке (обязательно), активен, клиентское наименование (обязательно), описание.
- Характеристики из поставки (read-only или подтягиваются): наименование из поставки, сорт (только для админа), цвет, страна, базовая высота стебля, вес стебля. Сорт и страна не отдаём наружу.
- Клиентские параметры: базовая цена, основное фото.
- Атрибуты товара: список выбранных атрибутов с вариантами.
- Кнопки: сохранить; удалить (при редактировании); отмена.

### 2.2. Акции
Акционные товары могут не иметь поставки; используются для аукционов, спецпредложений и распродаж.

#### 2.2.1. Список акций
- Колонки: ID, название, тип акции (sale/auction/lottery/др.), активность, период действия, цена (если применимо).
- Действия: редактировать, удалить.

#### 2.2.2. Карточка акции
- Поля: название, тип (скидка/аукцион/розыгрыш/другое), описание, цена (если релевантно), фото, период действия (начало/конец), активность.
- Опционально: привязка к товару (ID), если акция меняет цену товара; привязка к поставке необязательная и только для аналитики.

#### 2.2.3. Аукцион как товар-лот
Реализовать механику аукциона для товара-лота: пользователи делают ставки с заданным шагом, есть “блиц-цена” (мгновенный выкуп), продление времени при ставке в последние 5 минут, победитель фиксируется автоматически после завершения.

##### 2.2.3.1. Сущности и поля
**Лот (auction_lots)** — товар особого типа, количество выбрать нельзя (лот покупают 1 раз).

- id
- title — название
- description — описание
- image — фото (URL/путь)
- store_price — обычная цена букета в магазине (для сравнения)
- start_price — стартовая цена (по умолчанию 1.00)
- bid_step — шаг ставки (задаётся в админке, например 10/20/50 ₽)
- blitz_price — блиц-цена (выкуп без ожидания окончания)
- starts_at — дата/время старта аукциона
- ends_at — дата/время окончания аукциона (динамическое, может продлеваться)
- original_ends_at — исходное окончание (для аналитики и честности)
- status — draft | active | finished | cancelled
- winner_user_id — победитель (nullable)
- winning_bid_id — выигравшая ставка (nullable)
- created_at, updated_at

**Ставки (auction_bids)**:
- id
- lot_id
- user_id
- amount — сумма ставки
- status — active | cancelled
- created_at
- cancelled_at (nullable)
- cancel_reason (nullable)

##### 2.2.3.2. Правила аукциона (бизнес-логика)
- **Активность лота**: status = active и now между starts_at и ends_at.
- **Текущая цена**:
  - если ставок нет → текущая цена = start_price
  - если ставки есть → текущая цена = максимальная активная ставка
- **Проверка шага ставки**:
  - >= start_price если ставок ещё нет
  - иначе >= current_price + bid_step
  - ошибка: “Минимальная ставка: X ₽ (шаг: Y ₽)”
- **Продление окончания (“антиснайпер”)**:
  - если ставка сделана при остатке времени <= 5 минут, то ends_at = now + 5 минут
  - original_ends_at не меняется
- **Блиц-цена (мгновенный выкуп)**:
  - создаётся ставка/покупка по цене blitz_price
  - лот сразу переводится в finished, ends_at = now
  - победитель = этот пользователь, winning_bid_id фиксируется
  - если blitz_price не задана — кнопки нет
- **Завершение аукциона**:
  - when now > ends_at: выбрать максимальную активную ставку, выставить winner_user_id, winning_bid_id, status = finished
  - если ставок нет: winner_user_id = null, status = finished (или finished_no_bids)
- **Отмена ставки**:
  - возможно только если now <= ends_at - 1 час, иначе ошибка “Отмена ставки доступна не позднее чем за 1 час до окончания”
  - ставка не удаляется: status = cancelled, cancelled_at заполняется
  - если отменена текущая максимальная — пересчитать текущую цену по следующей максимальной активной ставке

##### 2.2.3.3. UI/UX на сайте (карточка лота)
- Показываем фото, название, описание.
- “Обычная цена в магазине: N ₽” (зачёркнуто/справочно).
- Текущая ставка (или “Старт: 1 ₽”).
- Шаг ставки: “Шаг: X ₽”.
- Таймер до ends_at (динамический).
- Кнопки: “Сделать ставку”, при наличии blitz_price — “Выкупить за N ₽”.
- Ставка: либо ввод суммы, либо кнопка “Поставить X ₽” (current + step).
- История ставок: время + сумма + “……1234” (последние 4 цифры телефона) или “Участник #ID”.

##### 2.2.3.4. Админка (Акции → Аукционы)
- **Список лотов**: название, статус, старт/окончание (и текущее ends_at), текущая цена, блиц-цена, победитель (если завершён), действия: редактировать / выключить / удалить.
- **Карточка лота**: title, description, photo, store_price, start_price (по умолчанию 1), bid_step, blitz_price, starts_at, ends_at, активность.
- **Ограничения при редактировании активного лота**:
  - нельзя менять start_price после первой ставки
  - нельзя уменьшать ends_at, если уже были ставки
  - можно увеличивать ends_at вручную только с записью причины (опционально)

##### 2.2.3.5. Честность и аудит
- ставки не удаляются, только отменяются
- хранить original_ends_at
- логировать события: ставка создана, ставка отменена, блиц-выкуп, лот завершён и выбран победитель
- опционально: отдельная таблица auction_events для аудита

##### 2.2.3.6. API / эндпоинты (предложение)
- GET /api/auction/lot?id=123 — данные лота + текущая цена + таймер + последние ставки
- POST /api/auction/bid — поставить ставку {lot_id, amount?} (если amount не передан — ставим current+step)
- POST /api/auction/bid/cancel — отменить ставку {bid_id}
- POST /api/auction/blitz — блиц-выкуп {lot_id}

#### 2.2.4. Супер-цены с ограничением по времени/количеству
Обычный товар, в админке указывается количество букетов и время окончания акции.

### 2.3. Атрибуты (бывшие «Варианты оформления»)
Каждый атрибут — вариант товара, меняющий цену и/или фото.

#### 2.3.1. Справочник атрибутов
- Колонки: ID, название, тип (для отображения), активность.
- Карточка: название, опциональное описание, активность.

#### 2.3.2. Значения атрибутов (варианты)
- Поля: название варианта, дополнительная цена (может быть +/0/−), фото-override, активность.
- Примеры: высота стебля («40 см» +0, «50 см» +10 ₽ + фото), оформление («Без оформления» +0, «В крафте» +30 ₽ + фото, «Подарочная упаковка» +70 ₽ + фото).

#### 2.3.3. Привязка атрибутов к товару
- В карточке товара: выбор применимых атрибутов и вариантов.
- На фронте можно показывать как селекты или готовые варианты карточек с разной ценой.

### 2.4. Поставки
Управление еженедельными/разовыми поставками, включая стендинги.

#### 2.4.1. Список поставок
- Колонки: ID, название, дата поставки, сорт, высота стебля, страна, количество пачек всего, доступные пачки, флаг «Стендинг», флаг «Мелкий опт разрешён», статус (планируется/пришла/закрыта).
- Фильтры: по дате, статусу, флагу «Стендинг».

#### 2.4.2. Карточка поставки
- Общие: название, флаг «Стендинг», дата поставки.
- Параметры: сорт, цвет, высота стебля, вес стебля (опц.), страна, комментарий поставщика (опц.).
- Учёт пачек: количество пачек всего, размер пачки (шт.), мелкий опт разрешён, системные поля (забронировано, доступно).
- Связь с товарами: список товаров из поставки (переход в карточку), кнопка «Создать товар из поставки» — черновик с авто-подтяжкой сорт/цвет/высота/страна.

#### 2.4.3. Логика мелкого опта
- При включённом мелком опте клиенты могут бронировать целые пачки на дату поставки; сумма броней не превышает общее число пачек.
- В БД: supply_id, user_id/клиент, количество пачек, дата/время, статус.

## 3. Связи между сущностями (черновая схема БД)
- supplies: id, name, is_standing, delivery_date, sort, color, height, weight, country, packs_total, pack_size, small_wholesale_enabled, status, timestamps.
- products: добавить supply_id (nullable), is_active; для обычных товаров supply_id != null, для акционных может быть null.
- promos: таблица акционных товаров (или promo_products) с необязательным product_id.
- attributes: справочник атрибутов; attribute_values: attribute_id, name, price_delta, photo; product_attribute_values: связь товар ↔ значение атрибута.
- supply_pack_reservations: supply_id, user_id, packs_reserved, status.

## 4. Бизнес-ограничения
- Сорт и страна доступны только в админке и не должны попадать в публичный API/клиентские тексты.
- Цены: базовая механика 89 ₽ за розу онлайн, спец-цена 75 ₽ для распродажи остатков; атрибуты меняют цену через price_delta.
- Привязка товара к поставке: обычный товар должен иметь supply_id; без поставки — акционный/виртуальный товар (обсуждается отдельно). Для стендингов допускается базовый товар с постоянными поставками для учёта остатков.

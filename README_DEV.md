# Bunch flowers — технический обзор проекта

Этот файл для *разработчиков*. Его цель — чтобы новый человек мог за 10–15 минут понять, что это за проект, как он устроен и куда копать дальше.

---

## 0. TL;DR

- **Что это**: мобильное веб‑приложение (PWA) Bunch flowers для продажи импортной красной розы премиум‑качества.
- **Город**: Красноярск (таймзона `Asia/Krasnoyarsk`).
- **Цель**: быстрый заказ и повторный заказ роз, плюс подписка на букеты.
- **Модель**: один базовый массовый продукт → большой оборот → низкая цена.
- **Стек**: PHP 8+ (свой лёгкий MVC), MySQL, vanilla JS, Tailwind CSS, Google Material Icons.
- **Инфраструктура**: shared‑хостинг, всё лежит в корне сайта, выходить выше нельзя.
- **Ключевые фичи**:
  - каталог;
  - акции, аукционы, распродажа остатков;
  - корзина;
  - подписка на букеты;
  - личный кабинет;
  - регистрация/логин по телефону + PIN (4 цифры) с интеграцией Telegram‑бота;
  - адреса доставки с несколькими получателями.

Для детальной схемы БД см. `DB_SCHEMA.md`.

---

## 1. Назначение проекта

Bunch flowers продаёт импортную красную розу премиум‑качества по честной цене за счёт:
- фокуса на одном базовом продукте;
- постоянного потока и быстрых оборотов;
- простого, понятного интерфейса.

Основные пользовательские сценарии:

1. **Разовый заказ**: быстро открыть сайт с телефона, выбрать количество роз, оформить доставку/самовывоз.
2. **Подписка**: настроить регулярную доставку букетов по адресу (дом, офис, родителям и т.д.).
3. **Акции и аукционы**: участие в аукционах (например, букет 51 роза), распродажа остатков по спец‑цене.
4. **Личный кабинет**: посмотреть историю заказов, настроить адреса и подписки, сменить PIN.

Приложение ориентировано на мобильный браузер + установку как PWA (“Добавить на экран”).

---

## 2. Технологический стек

### 2.1. Бэкенд

- PHP 8+ (без крупных фреймворков).
- Свой лёгкий MVC‑слой: `Controller`, `Model`, `View`, `Router`, `Auth`, `Session`.
- База данных: **MySQL**.

Параметры подключения к БД (боевые — не выкладывать в публичные репозитории):

- Host: `188.127.239.143`
- DB name: `bunch`
- User: `bunch`
- Password: `tM1pE1iN5g`

Подключение инкапсулировано в `app/core/Database.php` и настраивается через `config.php`.

### 2.2. Фронтэнд

- JavaScript: vanilla JS, модульная структура по страницам.
- CSS: Tailwind CSS (сборка локально, в репозиторий и на сервер уходит итоговый CSS).
- Иконки: Google Material Icons (подключение по CDN).
- Макет: mobile‑first, фиксированная верхняя плашка, скроллируемый контент, фиксированная нижняя навигация.

### 2.3. Таймзона

Все серверные даты/время — в таймзоне Красноярска:

```php
date_default_timezone_set('Asia/Krasnoyarsk');
```

---

## 3. Архитектура и структура каталогов

### 3.1. Общая идея

- Запуск через `index.php` в корне (фронт‑контроллер).
- Роутинг реализован через человекопонятные пути (`/promo`, `/cart` и т.д.).
- MVC разделён по папкам `/app/core`, `/app/controllers`, `/app/models`, `/app/views`.

### 3.2. Дерево проекта (упрощённо)

```text
/                 ← корень сайта (докрут)
├─ index.php      ← фронт‑контроллер, входная точка
├─ config.php     ← конфигурация, подключение БД и константы
├─ manifest.json  ← PWA‑манифест
├─ service-worker.js
├─ offline.html   ← fallback при отсутствии сети
│
├─ /app
│   ├─ /core
│   │   ├─ Controller.php
│   │   ├─ Model.php
│   │   ├─ View.php
│   │   ├─ Router.php
│   │   ├─ Database.php
│   │   ├─ Auth.php
│   │   └─ Session.php
│   │
│   ├─ /controllers
│   │   ├─ HomeController.php          ← главная (каталог)
│   │   ├─ ProductController.php       ← список товаров, детали
│   │   ├─ CartController.php          ← корзина
│   │   ├─ SubscriptionController.php  ← подписка на букеты
│   │   ├─ PromoController.php         ← акции, аукционы
│   │   ├─ AccountController.php       ← личный кабинет
│   │   └─ AuthController.php          ← логин/регистрация/PIN
│   │
│   ├─ /models
│   │   ├─ Product.php
│   │   ├─ Category.php
│   │   ├─ Cart.php
│   │   ├─ Subscription.php
│   │   ├─ Promo.php
│   │   ├─ User.php
│   │   ├─ UserAddress.php
│   │   ├─ Order.php
│   │   └─ OrderItem.php
│   │
│   └─ /views
│       ├─ /layouts
│       │   └─ main.php                ← общий layout
│       ├─ /partials
│       │   ├─ header.php              ← верхняя плашка
│       │   ├─ bottom-nav.php          ← нижняя навигация
│       │   ├─ product-card.php
│       │   ├─ promo-banner.php
│       │   └─ alerts.php
│       ├─ home.php
│       ├─ catalog.php
│       ├─ cart.php
│       ├─ subscription.php
│       ├─ account.php
│       ├─ login.php
│       └─ register.php
│
├─ /assets
│   ├─ /css
│   │   ├─ tailwind.css
│   │   └─ app.css
│   ├─ /js
│   │   ├─ app.js
│   │   ├─ router.js
│   │   ├─ api.js
│   │   └─ /pages
│   │       ├─ home.js
│   │       ├─ catalog.js
│   │       ├─ cart.js
│   │       ├─ subscription.js
│   │       ├─ account.js
│   │       └─ auth.js
│   ├─ /img
│   │   ├─ logo.svg
│   │   ├─ /ui
│   │   └─ /pwa-icons
│   └─ /fonts
│
└─ /api
    ├─ cart.php
    ├─ subscription.php
    ├─ auth.php
    └─ account.php
```

---

## 4. UI и основные страницы

### 4.1. Каркас приложения

Все страницы рендерятся через `views/layouts/main.php`:

- **Верхняя плашка (`partials/header.php`)**
  - слева: иконка “меню” (бургер) — placeholder под боковое меню/настройки;
  - по центру: логотип Bunch flowers.
- **Основной контент**:
  ```html
  <main id="app-content">
      <!-- сюда рендэрится конкретный view -->
  </main>
  ```
- **Нижняя навигация (`partials/bottom-nav.php`)**:
  - `home` — главная;
  - `local_offer` — акции;
  - `shopping_cart` — корзина;
  - `favorite`/`redeem` — подписка;
  - `person` — личный кабинет.

Навигация может работать как обычные ссылки (`/promo`, `/cart` и т.д.), опционально дополняется JS‑роутером для частичной перезагрузки.

### 4.2. Страницы

1. **Главная (`/`)**
   - контроллер: `HomeController@index`
   - список основных предложений (базовая роза, наборы, мини‑акции).

2. **Каталог (`/catalog`)**
   - контроллер: `ProductController@catalog`
   - расширенный список товаров: разные размеры, упаковки, наборы.

3. **Корзина (`/cart`)**
   - контроллер: `CartController@index`
   - управление позициями, переход к оформлению.

4. **Подписка (`/subscription`)**
   - контроллер: `SubscriptionController@index`
   - выбор плана (частота, длительность), выбор адреса/получателя.

5. **Акции (`/promo`)**
   - контроллер: `PromoController@index`
   - аукционы, розыгрыши, распродажа остатков по спец‑цене.

6. **Личный кабинет (`/account`)**
   - контроллер: `AccountController@index`
   - профиль, адреса, подписки, история заказов, смена PIN.

7. **Логин (`/login`)**
   - контроллер: `AuthController@login`
   - авторизация по телефону + PIN.

8. **Регистрация (`/register`)**
   - контроллер: `AuthController@register`
   - базовая регистрация, можно предусмотреть связку с Telegram.

---

## 5. Модели и основные сущности

Кратко — см. детализацию структур в `DB_SCHEMA.md`.

Главные сущности:

- `User` — клиент, авторизация по телефону + PIN.
- `UserAddress` — адреса клиента с отдельным получателем на каждом адресе.
- `Product` — товары (базовая роза и возможные варианты наборов).
- `Promo` — акции, аукционы, распродажа остатков.
- `Cart` / `CartItem` — корзина (минимально можно хранить в сессии, при желании — в БД).
- `Order` / `OrderItem` — заказы.
- `Subscription` — подписки на регулярную доставку.

---

## 6. Бизнес‑ограничения (важно)

### 6.1. Описание розы

В **клиентских текстах** (сайт, боты, посты, объявления):

- нельзя указывать реальную страну происхождения и конкретный сорт;
- используем формулировки:
  - “импортная красная роза премиум‑качества”;
  - “это не российская и не китайская роза — качество и стойкость выше”;
  - “бутон плотный, аккуратный, чуть меньше по размеру, чем у эквадорской розы”.

Разработчик должен помнить об этом при:
- наполнении тестовыми данными;
- верстке шаблонов с описаниями;
- любых автогенерациях текстов.

### 6.2. Цены

- Базовая онлайн‑цена: **89 ₽ за розу**.
- Распродажа остатков: **75 ₽ за розу** — нижняя разумная цена в рамках акций.
- Любые другие цены в коде/seed‑данных должны соответствовать экономике из `info.txt`. Если нужно экспериментальное промо — оформляем как гипотезу и **не** шьём жёстко в код.

### 6.3. Зоны доставки и DaData

- Админка: страница `/admin-services-delivery` отрисовывает карту Leaflet (OSM) и список зон. Можно рисовать/редактировать полигоны, задавать название, цену, приоритет, цвет и активность зоны. Кнопка «Сохранить» отправляет `POST /api/delivery/zones` и увеличивает `delivery_pricing_version` в БД.
- API: `GET /api/delivery/zones` отдаёт `shop`, `version` и массив зон. По умолчанию возвращаются только активные зоны, отсортированные по `priority DESC`. Для выгрузки всех зон добавить `?include_inactive=1`.
- Формат хранения полигона: массив точек `[lon, lat]` (как в Leaflet). Таблицы — `delivery_zones` и `delivery_pricing_meta` (см. `db_schema.sql`).
- Фронт корзины использует DaData‑подсказки для поиска адреса, забирает координаты из выбранной подсказки и автоматически подбирает зону. Если точка вне полигонов — отображается «по согласованию» и ставится флаг `delivery_needs_confirmation`.

---

## 7. Авторизация через PIN и Telegram‑бот

### 7.1. Общая схема

- Логин на сайте: **телефон + PIN (4 цифры)**.
- PIN:
  - генерируется и/или восстанавливается через Telegram‑бота;
  - может быть изменён пользователем в личном кабинете;
  - хранится в БД только в виде `pin_hash` (`password_hash()`), не в открытом виде.

Основные поля см. в `DB_SCHEMA.md` (`users`).

### 7.2. Потоки

**Регистрация/подключение через бота:**

1. Пользователь пишет боту.
2. Бот запрашивает телефон.
3. Создаётся/обновляется запись в `users`:
   - `phone`,
   - `telegram_chat_id`,
   - `telegram_username`,
   - `pin_hash` (сгенерированный 4‑значный PIN).
4. PIN отправляется в Telegram.
5. Пользователь логинится в веб‑приложение по телефону + PIN.

**Восстановление PIN:**

1. В боте — команда “Забыли PIN”.
2. По `telegram_chat_id` ищем пользователя, генерим новый PIN.
3. Обновляем `pin_hash`, отправляем PIN в Telegram.

**Смена PIN в личном кабинете:**

- Форма: текущий PIN, новый PIN (4 цифры), повтор нового.
- Проверка текущего PIN → `password_verify`.
- Проверка формата нового PIN (`^\d{4}$`), перезапись `pin_hash`.

### 7.3. Защита от перебора

В `users`:

- `failed_pin_attempts`
- `last_failed_pin_at`

На уровне приложения:

- после N (например, 5) неудачных попыток за короткий период желательно временно блокировать логин и/или усложнять капчей.

---

## 8. PWA: manifest и service worker

### 8.1. `manifest.json`

Базовые поля:

- `name`: `Bunch flowers`
- `short_name`: `Bunch`
- `start_url`: `"/"`
- `display`: `"standalone"`
- `background_color` / `theme_color`: брендовые цвета.
- `icons`: PNG‑иконки (192x192, 512x512) из `assets/img/pwa-icons/`.

### 8.2. `service-worker.js`

Минимально:

- во время `install` — закэшировать:
  - `index.php` / главную страницу;
  - `assets/css/tailwind.css`, `assets/css/app.css`;
  - `assets/js/app.js`;
  - логотип, иконки.
- в `fetch` — стратегия “network first с fallback в кэш” для HTML и “cache first” для статических ресурсов.
- при полном отсутствии сети — отдавать `offline.html`.

---

## 9. Локальная разработка

Рекомендуемый набор:

- PHP 8+, MySQL/MariaDB.
- Node.js — для сборки Tailwind.

Шаги:

1. Клонировать проект.
2. Настроить локальный веб‑сервер (виртуальный хост или `php -S localhost:8000 -t .`).
3. Создать локальную БД `bunch`, применить SQL из `DB_SCHEMA.md` (и/или дамп).
4. Настроить `config.php` под локальные параметры.
5. Собрать CSS:
   ```bash
   npm install
   npx tailwindcss -i ./assets/css/src/tailwind.css -o ./assets/css/tailwind.css --watch
   ```

---

## 10. Деплой на shared‑хостинг

1. Выгрузить файлы в корень сайта.
2. Настроить `config.php` под боевую БД.
3. Убедиться, что `index.php` — entrypoint.
4. Проверить, что PHP‑версии и расширения (PDO, PDO MySQL) доступны.
5. Обновить `manifest.json` и PWA‑иконки при изменениях брендинга.

---

## 11. Стиль кода и договорённости

- PHP:
  - по возможности придерживаться PSR‑12;
  - контроллеры — тонкие, минимальная бизнес‑логика;
  - бизнес‑логика — в моделях/сервисах.
- JS:
  - разбивка по модулям страниц (`assets/js/pages/...`);
  - без тяжёлых фреймворков.
- CSS:
  - максимально использовать Tailwind‑классы;
  - `app.css` — только для редких override‑ов и глобальных мелочей.
- Комментарии:
  - по делу, кратко, без дублирования очевидного.

---

## 12. Куда смотреть дальше

- `DB_SCHEMA.md` — точные структуры таблиц и комментарии по полям.
- `docs/product_brief.md` — подтверждённые требования для B2C на старте (Красноярск, подписки, оплата, роли, аналитика).
- `info.txt` — бизнес‑описание, экономика, идеи по промо/акциям и дорожная карта.
- Команда Bunch flowers — источник правды по условиям, ценам и текстам для клиентов.
